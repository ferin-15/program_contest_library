# 線形計画問題
tag: 競技プログラミング

線形計画問題(LP)とは行列 $A \in \mathbb{R}^{m \times n}$，ベクトル $\bm{b} \in \mathbb{R}^m, \bm{c} \in \mathbb{R}^n$ について $\max\{\bm{c}^{\top}\bm{x}:A\bm{x}\leq \bm{b}, \bm{x}\in\mathbb{R}^n \}$ を求める問題で，よく以下の形式で表記されます．

いつもの たぶん画像じゃないと無理

最大化したい関数のことを目的関数，変数について制約をかける(不)等式を制約式と呼びます．線形計画問題ではこれらの式が線形の式となっています．もし，変数 $\bm{x}$ が整数であれば整数計画問題，2次式で記述されるのであれば2次計画問題となります．

## 不等式標準形
上述したLPの書き方は不等式標準形と呼ばれるものです．この書き方では $\geq$ の向きの不等式がなかったり $\bm{x}$ が非負である制約がついていますが，実は全ての線形の(不)等式をこの形式で取り扱うことができます．

* 等式制約 $A\bm{x} = \bm{b}$
$\bm{b} \leq A\bm{x} \leq \bm{b}$ と言い換えます
* 不等式制約 $A\bm{x} \geq b$
両辺に-1を掛けることで不等式の向きを反転します
* 最小化問題 $\text{minimize}\ \ c^{\top}\bm{x}$
$\bm{c}$ を $-\bm{c}$ で置き換えます

## LPの解のパターン
LPを解いた結果得られる答えは大きく分けて 実行不可能，非有界，最適解 の3パターンがあります．

* 実行不可能： 制約式を満たす $\bm{x}$ が存在しないパターンです
* 非有界: $\bm{c}^{\top} \bm{x}$ を無限に大きくできるパターンです
* 最適解

有界であるが最適値が一意に定まらない，つまり上界supは存在しているが上限maxが存在しないようなパターンはないことが知られています．（注：LP以外の2次計画問題などでは有界でも最適解が得られないパターンも普通にあります．）

## LPの表現力
LPでは線形の式しか使うことができませんが，意外と色々な問題をLPで表現することができます．表現可能な問題の例をいくつか紹介します．

##### 最小値の最大化
競プロでは二分探索でおなじみですが，LPで書くこともできます．
\text{maximize} \quad min({x_1, \ldots, x_n})

$\min(\{x_1, \ldots, x_n\}) = y$ とすることで以下のように書けます．
\begin{align}
\text{maximize} & \quad y
\text{subject to} & \quad x_i \geq y (1 \leq i \leq n)
\end{align}

制約式を満たす $\bm{x}$ の中には $\min(\{x_1, \ldots, x_n\}) = y$ とならないものも存在しますが，目的関数で $y$ を最大化していることから最適解では必ず $\min(\{x_1, \ldots, x_n\}) = y$ となります．

##### 絶対値の最小化
\text{minimize} \quad \sum_{i=1}^n |c_i-x_i|

$t_i = |c_i-x_i|$ となる変数を使うことで以下のように書けます．
\begin{align}
\text{minimize} & \quad \sum_{i=1}^n t_i
\text{subject to} & \quad -t_i \leq c_i-x_i \leq t_i
\end{align}

## LPを解くアルゴリズム
楕円体法や内点法を用いることでLPは多項式時間で解くことができます．しかし，これらのアルゴリズムは複雑なのでここでは双対単体法を紹介します．

$J$ を行の添字の集合とします．$J$ に含まれる行のみからなる $A$ の部分行列を $A_J$，$b$ の部分ベクトルを $b_J$ と表します．

$A \in \mathbb{R}^{m \times n}, \bm{b} \in \mathbb{R}^{m}, \bm{c} \in \mathbb{R}^{n}$ と $A\bm{x} \leq \bm{b}$ の制約を満たす $\bm{x}$ が入力として与えられるとします．このとき，以下の手順を行うことでLPを解くことができます．
1. $A_{J}$ が正則で $A_J\bm{x} = b_J$ となる $n$ 個の行の添字の集合 $J$ を選びます．
2. $J$ に含まれないすべての $k$ の $y_k$ を0としたときに $\bm{c} = \bm{y}^{\top}A$ となる $\bm{y}$ を求めます．$\bm{y} = \bm{c}^{\top} A_J^{-1}$ と求めることができます．$\bm{y}$ の全ての要素が0以上ならば，$\bm{x}$ を最適解として返し終了します．(このとき $y$ は双対問題の解となっています．)
3. $i$ を $y_i < 0$ となる最小の添字とします．$-(A_J)^{-1}$ の第 $i$ 列を $w$ とします．もし $Aw$ のすべての要素が0以下ならば，非有界であると返し終了します．
4. $\lambda = \min\{\frac{b_j-A_jx}{A_jw} : j\in\{1,\ldots,m\}, A_jw > 0\}$ を求めます．最小値を達成するうち最小のものを $j$ とします．
5. $J = (J\setminus\{i\}) \cup \{j\}, \bm{x} = \bm{x} + \lambda\bm{w}$ として，2番へ戻ります．

このアルゴリズムは有限回の反復で終了すること，$\bm{x}$ が最適解であることが証明できます．(最適性の証明はアルゴリズム終了時に $\bm{c}^{\top} \bm{x} = \bm{y}^{\top} \bm{b}$ となること，弱双対性から $\bm{c}^{\top} \bm{x} \leq \bm{y}^{\top} \bm{b}$ となることを用います．)

このアルゴリズムは多くの場合高速に終了します．一方で，指数回の反復を必要とする入力も存在していて，多項式時間アルゴリズムではありません．3,4番で $i,j$ を選ぶ方法(ピボットルール)について多くの方法が研究されていますが，多項式時間で終わるピボットルールが存在するかは未解決問題（だったはず）です．

アルゴリズムの入力として制約を満たす $\bm{x}$ を与えています．これをどのように求めるのか？について考えます．$\bm{b}$ のうち非負の要素が $\bm{b}'$，負の要素が $\bm{b}''$ に割り当てられるように，2つのベクトル $\bm{b}', \bm{b}''$ に分割します．対応するように $A$ を $A',A''$ に分割します．これを用いて $\max\{c^{\top}x : A\bm{x}\}$ は $\max\{c^{\top}x:A'\bm{x}\leq\bm{b}', A''\bm{x}\leq\bm{b}'', \bm{x}\geq 0 \}$ と書くことができます．(不等式標準形のところで説明したような変形を考えると同値な変形と言えます．) 

次の線形計画問題 $\min\{(\bm{1}A'')\bm{x}+\bm{1}\bm{y}: A'\bm{x}\leq\bm{b}', A''\bm{x}+\bm{y}\geq\bm{b}'', \bm{x},\bm{y}\geq 0 \}$ に対して単体法を適用します．このLPは最小値が少なくとも $\bm{1}\bm{b}''$ となるので有界です．元問題の実行可能解 $\bm{x}$ に対して $(\bm{x} \bm{y}) = (\bm{x} \bm{b}''-A''\bm{x}$ は実行可能解で $\bm{1}\bm{b}''$ を返します．よって，最適値が $\bm{1}\bm{b}''$ を返さない場合，元問題は実行不可能です．$\bm{1}\bm{b}''$ を返す場合，$\bm{x}$ が実行可能解です．

#### 実装
タブローでやる